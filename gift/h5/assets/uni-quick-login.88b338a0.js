var e=Object.defineProperty,i=Object.defineProperties,o=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,l=(i,o,t)=>o in i?e(i,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[o]=t,a=(e,i)=>{for(var o in i||(i={}))n.call(i,o)&&l(e,o,i[o]);if(t)for(var o of t(i))s.call(i,o)&&l(e,o,i[o]);return e},r=(e,t)=>i(e,o(t));import{m as g,S as c,a as u,a2 as p,a3 as f,a4 as d,a5 as h,n as y,P as v,O as m,R as b,a6 as x,Q as k,o as L,c as w,w as C,b as S,e as _,r as I,j as O,t as B,F as R,k as A,l as j,i as q}from"./index.18541c3e.js";import{l as P}from"./loginSuccess.1f625296.js";import{_ as Q}from"./plugin-vue_export-helper.21dcd24c.js";var U={en:{accountLogin:"Account",SMSLogin:"SMS",wechatLogin:"wechat",appleLogin:"Apple",oneClickLogin:"One click login",QQLogin:"QQ",xiaomiLogin:"Xiaomi",getProviderFail:"Failed to get service provider",loginErr:"Login service initialization error",chooseOtherLogin:"Click the third-party login",weibo:"weibo",noAgree:"You have not agreed to the privacy policy agreement",gotIt:"got it"},"zh-Hans":{accountLogin:"账号登录",SMSLogin:"短信验证码",wechatLogin:"微信登录",appleLogin:"苹果登录",oneClickLogin:"一键登录",QQLogin:"QQ登录",xiaomiLogin:"小米登录",getProviderFail:"获取服务供应商失败",loginErr:"登录服务初始化错误",chooseOtherLogin:"点击了第三方登录",weibo:"微博",noAgree:"你未同意隐私政策协议",gotIt:"知道了"}};const{t:M}=g(U);c.database().collection("uni-id-users");var T=Q({computed:{loginConfig:()=>u().globalData.config.router.login,agreements:()=>u().globalData.config.about.agreements||[]},data:()=>({servicesList:[{id:"username",text:M("accountLogin"),logo:"/static/uni-quick-login/user.png",path:"/pages/ucenter/login-page/pwd-login/pwd-login"},{id:"smsCode",text:M("SMSLogin"),logo:"/static/uni-quick-login/sms.png",path:"/pages/ucenter/login-page/index/index?type=smsCode"},{id:"weixin",text:M("wechatLogin"),logo:"/static/uni-quick-login/wechat.png"},{id:"apple",text:M("appleLogin"),logo:"/static/uni-quick-login/apple.png"},{id:"univerify",text:M("oneClickLogin"),logo:"/static/uni-quick-login/univerify.png"},{id:"qq",text:M("QQLogin"),logo:"/static/uni-quick-login/univerify.png"},{id:"xiaomi",text:M("xiaomiLogin"),logo:"/static/uni-quick-login/univerify.png"},{id:"sinaweibo",text:M("weibo"),logo:"/static/uni-quick-login/univerify.png"}],config:{},univerifyStyle:{fullScreen:!0,backgroundColor:"#ffffff",buttons:{iconWidth:"45px",list:[]},privacyTerms:{defaultCheckBoxState:!1,textColor:"#BBBBBB",termsColor:"#5496E3",prefix:"我已阅读并同意",suffix:"并使用本机号码登录",privacyItems:[]}}}),watch:{agree(e){this.univerifyStyle.privacyTerms.defaultCheckBoxState=e}},props:{agree:{type:Boolean,default:()=>!1}},async created(){let e=this.servicesList;e=e.filter((e=>this.loginConfig.includes(e.id))),this.loginConfig.includes("univerify")&&(this.univerifyStyle.privacyTerms.privacyItems=this.agreements,e.forEach((({id:e,logo:i,path:o})=>{"univerify"!=e&&this.univerifyStyle.buttons.list.push({iconPath:i,provider:e})}))),console.log(e),"/pages/ucenter/login-page/index/index"==this.getRoute(1)&&["weixin","apple"].includes(this.loginConfig[0])&&(e=e.filter((e=>e.id!=this.loginConfig[0]))),this.servicesList=e.filter((e=>(e.path?e.path.split("?")[0]:"")!=this.getRoute(1))),console.log("servicesList",e,this.servicesList)},mounted(){},methods:r(a({},p({setUserInfo:"user/login"})),{getRoute(e=0){let i=f();return e>i.length?"":"/"+i[i.length-e].route},to(e){if(console.log("比较",this.getRoute(1),this.getRoute(2),e),this.getRoute(1)==e.split("?")[0]&&"/pages/ucenter/login-page/index/index"==this.getRoute(1)){let i=e.split("?")[1].split("=")[1];d("setLoginType",i)}else this.getRoute(2)==e?h():this.getRoute(1)!=e?y({url:e,animationType:"slide-in-left"}):console.log("出乎意料的情况,path："+e)},login_before(e,i=!0){if(console.log(e),!this.agree&&"univerify"!=e)return v({title:M("noAgree"),icon:"none"});if(m({mask:!0}),"univerify"==e&&uni.getUniverifyManager){let e=function(){b(),i.close(),i.offButtonsClick(o)},i=uni.getUniverifyManager();console.log("是新版");let o=async i=>{console.log("点击了第三方登录，provider：",i,i.provider,this.univerifyStyle.buttons.list);let o=(await uni.getCheckBoxState())[1].state;console.log("agree",o),d("setAgreementsAgree",o);let{path:t}=this.univerifyStyle.buttons.list[i.index];console.log("path",t,this.getRoute(1)),t?(this.to(t),e()):o?(e(),setTimeout((()=>{console.log("login_before"),this.login_before(i.provider)}),500)):(console.log(M("noAgree")),v({title:M("noAgree"),icon:"none"}))};return i.onButtonsClick(o),i.login({univerifyStyle:this.univerifyStyle,success:e=>{console.log("login success",e),this.login(e.authResult,"univerify")},fail(e){v({title:JSON.stringify(e),icon:"none"})},complete(e){b(),i.offButtonsClick(o)}})}x({provider:e,onlyAuthorize:!0,univerifyStyle:this.univerifyStyle,complete:e=>{console.log(e),b()},success:async i=>{if(console.log(i),"apple"==e){let e=await this.getUserInfo({provider:"apple"});Object.assign(i.authResult,e.userInfo)}this.login("weixin"==e?i.code:i.authResult,e)},fail:async o=>{if(console.log(o),"univerify"==e&&!uni.getUniverifyManager)switch(o.metadata&&o.metadata.error_data&&v({title:M("oneClickLogin")+":"+o.metadata.error_data,icon:"none"}),o.errMsg&&v({title:M("oneClickLogin")+":"+o.errMsg,icon:"none"}),o.errCode){case 30002:console.log("在一键登录界面，点击其他登录方式");break;case 30003:console.log("关闭了登录"),i&&h();break;case 30006:k({title:M("loginErr"),content:o.metadata.error_data,showCancel:!1,confirmText:M("gotIt")});break;case"30008":console.log("点击了第三方登录，provider：",o.provider);let e=(await uni.getCheckBoxState())[1].state;console.log("agree",e),d("setAgreementsAgree",e);let{path:t}=this.univerifyStyle.buttons.list[res.index];console.log("path",t),t?this.to(t):setTimeout((()=>{console.log("agree",this.agree),this.login_before(o.provider)}),500);break;default:console.log(o)}}})},login(e,i){console.log({params:e,type:i});let o="loginBy"+i.trim().toLowerCase().replace(i[0],i[0].toUpperCase());c.callFunction({name:"uni-id-cf",data:{action:o,params:e},success:async({result:e})=>{console.log("login-result",e),0===e.code?(delete e.userInfo.token,"register"==e.type&&(e.userInfo._id=e.uid),this.setUserInfo(e.userInfo),P(e)):k({content:e.msg,showCancel:!1})},complete:e=>{console.log(e),"univerify"==i&&uni.closeAuthView(),b()}})},doUserProfileNext(){P()},getUserInfo:async e=>new Promise(((i,o)=>{uni.getUserInfo(r(a({},e),{success:e=>{i(e)},fail:e=>{k({content:JSON.stringify(e),showCancel:!1}),o(e)}}))}))})},[["render",function(e,i,o,t,n,s){const l=A,a=j,r=q;return L(),w(r,null,{default:C((()=>[S(r,{class:"quick-login-box"},{default:C((()=>[(L(!0),_(R,null,I(n.servicesList,((e,i)=>(L(),w(r,{class:"item",key:i,onClick:i=>e.path?s.to(e.path):s.login_before(e.id,!1)},{default:C((()=>[S(l,{class:"logo",src:e.logo,mode:"widthFix"},null,8,["src"]),S(a,{class:"login-title"},{default:C((()=>[O(B(e.text),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1})}],["__scopeId","data-v-45b465cc"]]);export{T as _};
